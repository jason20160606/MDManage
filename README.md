# 经销商库存管理系统

## 项目概述

这是一个基于.NET 9 Core Web API的经销商库存管理系统，主要用于管理经销商的商品库存和库存调整操作。

## 主要功能

### 1. 经销商管理
- 获取经销商列表（支持分页和搜索）
- 根据ID或名称查询经销商信息
- 创建和更新经销商信息

### 2. 库存管理
- 从XML配置文件读取经销商库存信息
- 支持库存调整操作
- 针对不同产品类型实现特殊的库存逻辑

## 特殊产品库存逻辑

### 家庭套与家庭套（新疆西藏）
- **合并计算**：两个产品的数量合并后统一计算库存
- **计算方式**：`(家庭套数量 + 家庭套（新疆西藏）数量) × DeductRatio` 取整
- **扣减比例**：从家庭套XML配置的DeductRatio字段读取
- **库存基准**：使用家庭套的Stock作为基准计算余量
- **余数处理**：当余数不为0时，扣减库存需加1
- **邮费计算**：分别计算两个产品的邮费后相加
- **计算示例**：
  - 家庭套1件，家庭套（新疆西藏）3件，DeductRatio=0.7
  - 合并数量：1 + 3 = 4
  - 扣减计算：4 × 0.7 = 2.8
  - 临时扣减：2（取整）
  - 余数：0.8
  - 最终扣减：2 + 1 = 3（余数不为0，加1）
  - 最终余量：0.8（保存到家庭套的Stock）

### 洗衣液（整箱）
- **邮费处理**：使用用户输入的邮费，而不是配置文件中的默认邮费
- **库存扣减**：直接扣减下单数量
- **余量处理**：不改变当前余量

### 洗衣液（普通）
- **库存扣减逻辑**：`(产品数量 + Stock) × DeductRatio` 取整
- **特殊规则**：当余数不为0时，扣减库存需加1，Stock的值为余数×10
- **邮费计算**：使用配置文件中的邮费单价
- **计算示例**：
  - 下单10件，当前余量0.5，扣减比例0.1
  - 总计：(10 + 0.5) × 0.1 = 1.05
  - 临时扣减：1（取整）
  - 余数：0.05
  - 最终扣减：1 + 1 = 2（余数不为0，加1）
  - 最终余量：0.05 × 10 = 0.5

### 3瓶装洗护
- **库存扣减逻辑**：下单3件扣1个库存
- **计算方式**：`(下单量 + 当前余量) ÷ 3` 取整
- **特殊规则**：当余数不为0时，扣减库存需加1，余数为 `1 - 余数`
- **余量保存**：计算余数并保存到Stock字段
- **邮费计算**：使用配置文件中的邮费单价

### 洗脸巾
- **库存扣减逻辑**：下单3件扣1个库存（与3瓶装洗护相同）
- **特殊规则**：当余数不为0时，扣减库存需加1，余数为 `1 - 余数`
- **差价计算**：`产品数量 × 差价 = 总差价`
- **XML配置**：需要在Product标签中添加`Agio`属性

### 其他产品
- 使用原有的库存扣减逻辑
- 基于`DeductRatio`（扣减比例）进行计算

## 库存计算示例

### 家庭套合并计算示例

**示例1：家庭套1件，家庭套（新疆西藏）3件，当前余量0.5，DeductRatio=0.7**
- 合并数量：1 + 3 = 4
- 扣减计算：4 × 0.7 = 2.8
- 临时扣减：2（取整）
- 余数：0.8
- 最终扣减：2 + 1 = 3（余数不为0，加1）
- 最终余量：0.8（保存到家庭套的Stock）

**示例2：家庭套2件，家庭套（新疆西藏）1件，当前余量0.3，DeductRatio=0.7**
- 合并数量：2 + 1 = 3
- 扣减计算：3 × 0.7 = 2.1
- 临时扣减：2（取整）
- 余数：0.1
- 最终扣减：2 + 1 = 3（余数不为0，加1）
- 最终余量：0.1（保存到家庭套的Stock）

**示例3：家庭套5件，家庭套（新疆西藏）0件，当前余量0.8，DeductRatio=0.7**
- 合并数量：5 + 0 = 5
- 扣减计算：5 × 0.7 = 3.5
- 临时扣减：3（取整）
- 余数：0.5
- 最终扣减：3 + 1 = 4（余数不为0，加1）
- 最终余量：0.5（保存到家庭套的Stock）

### 洗衣液库存计算示例

**示例1：下单10件，当前余量0.5，扣减比例0.1**
- 总计：(10 + 0.5) × 0.1 = 1.05
- 临时扣减：1（取整）
- 余数：0.05
- 最终扣减：1 + 1 = 2（余数不为0，加1）
- 最终余量：0.05 × 10 = 0.5

**示例2：下单20件，当前余量0.8，扣减比例0.1**
- 总计：(20 + 0.8) × 0.1 = 2.08
- 临时扣减：2（取整）
- 余数：0.08
- 最终扣减：2 + 1 = 3（余数不为0，加1）
- 最终余量：0.08 × 10 = 0.8

**示例3：下单15件，当前余量0.2，扣减比例0.1**
- 总计：(15 + 0.2) × 0.1 = 1.52
- 临时扣减：1（取整）
- 余数：0.52
- 最终扣减：1 + 1 = 2（余数不为0，加1）
- 最终余量：0.52 × 10 = 5.2

### 3瓶装洗护/洗脸巾库存计算示例

**示例1：下单5件，当前余量1**
- 总计：5 + 1 = 6
- 临时扣减：6 ÷ 3 = 2
- 临时余数：6 - (2 × 3) = 0
- 最终扣减：2（余数为0，不加1）
- 最终余量：0

**示例2：下单4件，当前余量1**
- 总计：4 + 1 = 5
- 临时扣减：5 ÷ 3 = 1
- 临时余数：5 - (1 × 3) = 2
- 最终扣减：1 + 1 = 2（余数不为0，加1）
- 最终余量：1 - 2 = -1（但系统会设为0）

**示例3：下单2件，当前余量2**
- 总计：2 + 2 = 4
- 临时扣减：4 ÷ 3 = 1
- 临时余数：4 - (1 × 3) = 1
- 最终扣减：1 + 1 = 2（余数不为0，加1）
- 最终余量：1 - 1 = 0

## API接口说明

### 库存调整接口
```
POST /api/dealer/adjust-stock
```

**请求参数**：
```json
{
  "dealerId": 1,
  "items": [
    {
      "skuId": 1,
      "quantity": 1
    },
    {
      "skuId": 2,
      "quantity": 3
    },
    {
      "skuId": 5,
      "quantity": 10,
      "userInputPostage": 15.5
    }
  ]
}
```

**响应结果**：
```json
{
  "details": [
    "后台家庭套1件 + 新疆3件 = 4*0.7=2.8，之前余0.5，扣减库存3箱余0.8，邮费175.5",
    "后台洗衣液（整箱） 下单10件，邮费15.5，扣减库存10",
    "后台洗脸巾下单3组，3组扣1箱库存，之前余0，扣减库存1箱余0，邮费3*5=15，差价3*18.5=55.5",
    "邮费计算公式：家庭套: 1 × 13.5 = 13.5 + 家庭套（新疆西藏）: 3 × 54 = 162 + 洗衣液（整箱）: 邮费 15.5 + 洗脸巾: 3 × 5 = 15",
    "邮费合计：13.5 + 162 + 15.5 + 15 = 206",
    "洗脸巾差价：55.5",
    "最终合计：206 + 55.5 = 261.5",
    "总扣减库存：14"
  ],
  "totalPostage": 261.5
}
```

## XML配置文件结构

配置文件位置：`NET9CoreWebAPI/Config/BackstageProductStock{dealerId}.xml`

```xml
<?xml version="1.0" encoding="utf-8"?>
<BackstageProductStock>
  <Product Name="洗衣液（整箱）" SkuId="5" Stock="0" DeductRatio="1" Postage="1" />
  <Product Name="3瓶装洗护" SkuId="6" Stock="0" DeductRatio="0" Postage="5" />
  <Product Name="洗脸巾" SkuId="7" Stock="0" DeductRatio="1" Postage="5" Agio="18.5"/>
</BackstageProductStock>
```

### XML属性说明
- `Name`：产品名称
- `SkuId`：产品SKU ID
- `Stock`：当前库存余量
- `DeductRatio`：扣减比例（特殊产品可能为0）
- `Postage`：邮费单价
- `Agio`：差价（仅洗脸巾产品需要）

## 技术架构

- **框架**：.NET 9 Core Web API
- **数据库**：Entity Framework Core
- **配置存储**：XML文件
- **设计模式**：服务层模式

## 开发说明

### 代码结构
```
NET9CoreWebAPI/
├── ModelMapping/
│   └── Services/
│       └── DealerService.cs    # 经销商服务实现
├── Models/
│   └── Dtos/
│       └── DealerDto.cs        # 数据传输对象
└── Config/
    └── BackstageProductStock*.xml  # 库存配置文件
```

### 关键方法
- `GetDealersAsync()`：获取经销商列表
- `GetDealerStockXmlAsync()`：获取经销商库存
- `AdjustDealerStockAsync()`：调整经销商库存（核心方法）
- `AddOrUpdateDealerStockXmlAsync()`：添加或更新库存

## 使用注意事项

1. **洗衣液（整箱）**：必须提供`userInputPostage`参数
2. **3瓶装洗护和洗脸巾**：使用3:1的库存扣减逻辑，余数不为0时扣减库存加1
3. **洗脸巾**：需要在XML中配置`Agio`属性
4. **XML文件路径**：确保配置文件路径正确
5. **权限控制**：建议添加适当的权限验证

## 扩展建议

1. 添加库存预警功能
2. 实现库存历史记录
3. 支持批量导入库存数据
4. 添加库存报表功能
5. 实现实时库存同步